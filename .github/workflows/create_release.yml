name: Create release 
on:
  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:        
    - name: Checkout repository
      uses: actions/checkout@v3         

    - name: Prepare Release Notes
      id: prepare_notes
      run: |
        ARCHIVE_DIR=archive/integrations
        JSON_file=$ARCHIVE_DIR/config.json
        cat $JSON_file
        rec_num=$(jq '.integrations | length' $JSON_file)
        echo "rec_num: $rec_num"
        # create empty json object with "integrations" key
        echo '{"integrations": []}' > $ARCHIVE_DIR/Release.json
        for (( i=0; i < $rec_num; i++))
        do
          INTEGRATION_ID=$(jq -r '.integrations['$i'] | .code' $JSON_file)
          INTEGRATION_VERSION=$(jq -r '.integrations['$i'] | .version' $JSON_file)
          echo "INTEGRATION_ID: $INTEGRATION_ID"
          echo "INTEGRATION_VERSION: $INTEGRATION_VERSION"

          # copy the $INTEGRATION_ID.json from $INTEGRATION_ID_$INTEGRATION_VERSION folder to the archive/integrations/$INTEGRATION_ID.json
          cp $ARCHIVE_DIR/${INTEGRATION_ID}_${INTEGRATION_VERSION}/$INTEGRATION_ID.json $ARCHIVE_DIR/${INTEGRATION_ID}.json

          # append the json object to the "integrations" array in Release.json
          jq '.integrations += [input.integrations[0]]' $ARCHIVE_DIR/Release.json $ARCHIVE_DIR/${INTEGRATION_ID}.json > temp && mv temp $ARCHIVE_DIR/Release.json
        done
        cat $ARCHIVE_DIR/Release.json
        release_notes=$(jq -c . $ARCHIVE_DIR/Release.json)
        echo "release_notes=$release_notes" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          tag_name: 2.0.${{ github.run_number }}
          release_name: 2.0.${{ github.run_number }}
          draft: false
          prerelease: false
          body: |
            ## Release Notes
            Below Integration, connections & lookups files are included in this release.
            ${{ steps.prepare_notes.outputs.release_notes }}